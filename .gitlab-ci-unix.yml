spec:
  inputs:
    os:
    platform:
    tagname:
    cross_platform:
      default: 'no'
    build_flags:
      default: 'RELEASE=1'
    no_javascript:
      default: 'no'
    has_curses:
      default: 'yes'
---

".$[[ inputs.os ]]":
  extends: .rules
  tags: 
    - "$[[ inputs.tagname ]]"
  variables:
    CROSS_PLATFORM: "$[[ inputs.cross_platform ]]"
    OS: "$[[ inputs.os ]]"
    PLATFORM: "$[[ inputs.platform ]]"
    OSP: "$[[ inputs.os ]]-$[[ inputs.platform ]]"
    BUILD_FLAGS: "$[[ inputs.build_flags ]]"
    NO_JAVASCRIPT: "$[[ inputs.no_javascript ]]"
    HAS_CURSES: "$[[ inputs.has_curses ]]"
    GIT_STRATEGY: fetch

".$[[ inputs.os ]]-build":
  stage: build
  extends: .$[[ inputs.os ]]

".$[[ inputs.os ]]-test":
  stage: test
  extends: .$[[ inputs.os ]]

"spidermonkey-$[[ inputs.os ]]":
  extends:
    - .$[[ inputs.os ]]-build
    - .rules
  script:
    - cd 3rdp/build
    - touch depend
    - gmake ${BUILD_FLAGS} libmozjs
  artifacts:
    expire_in: 30 mins
    name: "spidermonkey-${OSP}"
    paths:
      - "3rdp/*.*.*.release/mozjs"
  rules:
    - if: $NO_JAVASCRIPT == "yes"
      when: never
    - changes:
      - src/**/*
      - 3rdp/**/*
      - ctrl/text.dat
      - xtrn/**/{GNUm,M}akefile
      - xtrn/**/*.{c,h,cpp,hpp,mk}

"cryptlib-$[[ inputs.os ]]":
  extends:
    - .$[[ inputs.os ]]-build
  script:
    - cd 3rdp/build
    - touch depend
    - gmake ${BUILD_FLAGS} cryptlib
  artifacts:
    expire_in: 30 mins
    name: "cryptlib-${OSP}"
    paths:
      - "3rdp/*.*.*.release/cl"

"xpdev-$[[ inputs.os ]]":
  extends:
    - .$[[ inputs.os ]]-build
  script:
    - cd src/xpdev
    - touch depend
    - gmake ${BUILD_FLAGS}
  artifacts:
    expire_in: 30 mins
    name: "xpdev-${OSP}"
    paths:
      - "src/xpdev/*.*.*.lib.release*"
      - "src/xpdev/*.*.*.obj.release*/*.o*"

"encode-$[[ inputs.os ]]":
  extends:
    - .$[[ inputs.os ]]-build
  script:
    - cd src/encode
    - touch depend
    - gmake ${BUILD_FLAGS}
  artifacts:
    expire_in: 30 mins
    name: "encode-${OSP}"
    paths:
      - "src/encode/*.*.*.lib.release*"
      - "src/encode/*.*.*.obj.release*/*.o*"

"hash-$[[ inputs.os ]]":
  extends:
    - .$[[ inputs.os ]]-build
  script:
    - cd src/hash
    - touch depend
    - gmake ${BUILD_FLAGS}
  artifacts:
    expire_in: 30 mins
    name: "hash-${OSP}"
    paths:
      - "src/hash/*.*.*.lib.release*"
      - "src/hash/*.*.*.obj.release*/*.o*"

"ciolib-$[[ inputs.os ]]":
  extends:
    - .$[[ inputs.os ]]-build
  script:
    - cd src/conio
    - touch depend
    - gmake ${BUILD_FLAGS}
  artifacts:
    expire_in: 30 mins
    name: "ciolib-${OSP}"
    paths:
      - "src/conio/*.*.*.lib.release*"
      - "src/conio/*.*.*.obj.release*/*.o*"

"sftp-$[[ inputs.os ]]":
  extends:
    - .$[[ inputs.os ]]-build
  script:
    - cd src/sftp
    - touch depend
    - gmake ${BUILD_FLAGS}
  artifacts:
    expire_in: 30 mins
    name: "sftp-${OSP}"
    paths:
      - "src/sftp/*.*.*.lib.release*"
      - "src/sftp/*.*.*.obj.release*/*.o*"

"smblib-$[[ inputs.os ]]":
  extends:
    - .$[[ inputs.os ]]-build
  script:
    - cd src/smblib
    - touch depend
    - gmake ${BUILD_FLAGS}
  artifacts:
    expire_in: 30 mins
    name: "smblib-${OSP}"
    paths:
      - "src/smblib/*.*.*.lib.release*"
      - "src/smblib/*.*.*.obj.release*/*.o*"

"uifc-$[[ inputs.os ]]":
  extends:
    - .$[[ inputs.os ]]-build
  script:
    - cd src/uifc
    - touch depend
    - touch xpdev
    - touch xpdev-mt
    - touch ciolib-mt
    - gmake ${BUILD_FLAGS}
  artifacts:
    expire_in: 30 mins
    name: "uifc-${OSP}"
    paths:
      - "src/uifc/*.*.*.lib.release*"
      - "src/uifc/*.*.*.obj.release*/*.o*"
  needs:
    - job: "xpdev-$[[ inputs.os ]]"
    - job: "ciolib-$[[ inputs.os ]]"

"gitinfo-$[[ inputs.os ]]":
  extends:
    - .$[[ inputs.os ]]-build
  script:
    - cd src/sbbs3
    - touch depend
    - gmake ${BUILD_FLAGS} gitinfo
  artifacts:
    expire_in: 30 mins
    name: "gitinfo-${OSP}"
    paths:
      - "src/sbbs3/git_*.h"

"scfg-$[[ inputs.os ]]":
  extends:
    - .$[[ inputs.os ]]-build
  script:
    - cd src/sbbs3/scfg
    - touch depend
    - touch xpdev
    - touch xpdev-mt
    - touch encode
    - touch hash
    - touch smblib
    - touch ciolib-mt
    - touch uifc
    - touch uifc-mt
    - touch cl
    - gmake ${BUILD_FLAGS} GIT=NO
  artifacts:
    expire_in: 30 mins
    name: "scfg-${OSP}"
    paths:
      - "src/sbbs3/scfg/*.exe.release/*"
      - "src/sbbs3/scfg/*.obj.release*/*.o*"
  needs:
    - job: "ciolib-$[[ inputs.os ]]"
    - job: "cryptlib-$[[ inputs.os ]]"
    - job: "encode-$[[ inputs.os ]]"
    - job: "hash-$[[ inputs.os ]]"
    - job: "smblib-$[[ inputs.os ]]"
    - job: "uifc-$[[ inputs.os ]]"
    - job: "xpdev-$[[ inputs.os ]]"
    - job: "gitinfo-$[[ inputs.os ]]"

"uedit-$[[ inputs.os ]]":
  extends:
    - .$[[ inputs.os ]]-build
  script:
    - cd src/sbbs3/uedit
    - touch depend
    - touch xpdev
    - touch xpdev-mt
    - touch encode
    - touch hash
    - touch smblib
    - touch ciolib-mt
    - touch uifc
    - touch uifc-mt
    - gmake ${BUILD_FLAGS} GIT=NO
  artifacts:
    expire_in: 30 mins
    name: "uedit-${OSP}"
    paths:
      - "src/sbbs3/uedit/*.exe.release/*"
      - "src/sbbs3/uedit/*.obj.release*/*.o*"
  needs:
    - job: "ciolib-$[[ inputs.os ]]"
    - job: "encode-$[[ inputs.os ]]"
    - job: "hash-$[[ inputs.os ]]"
    - job: "smblib-$[[ inputs.os ]]"
    - job: "uifc-$[[ inputs.os ]]"
    - job: "xpdev-$[[ inputs.os ]]"
    - job: "gitinfo-$[[ inputs.os ]]"
  rules:
    - if: $HAS_CURSES == "no"
      when: never
    - changes:
      - src/**/*
      - 3rdp/**/*
      - ctrl/text.dat
      - xtrn/**/{GNUm,M}akefile
      - xtrn/**/*.{c,h,cpp,hpp,mk}

"umonitor-$[[ inputs.os ]]":
  extends:
    - .$[[ inputs.os ]]-build
  script:
    - cd src/sbbs3/umonitor
    - touch depend
    - touch xpdev
    - touch xpdev-mt
    - touch encode
    - touch hash
    - touch smblib
    - touch ciolib-mt
    - touch uifc
    - touch uifc-mt
    - gmake ${BUILD_FLAGS}
  artifacts:
    expire_in: 30 mins
    name: "umonitor-${OSP}"
    paths:
      - "src/sbbs3/umonitor/*.exe.release/*"
      - "src/sbbs3/umonitor/*.obj.release*/*.o*"
  needs:
    - job: "ciolib-$[[ inputs.os ]]"
    - job: "encode-$[[ inputs.os ]]"
    - job: "hash-$[[ inputs.os ]]"
    - job: "smblib-$[[ inputs.os ]]"
    - job: "uifc-$[[ inputs.os ]]"
    - job: "xpdev-$[[ inputs.os ]]"

"utils-$[[ inputs.os ]]":
  extends:
    - .$[[ inputs.os ]]-build
  script:
    - cd src/sbbs3
    - touch depend
    - touch xpdev
    - touch xpdev-mt
    - touch encode
    - touch hash
    - touch smblib
    - touch ciolib-mt
    - touch uifc
    - touch uifc-mt
    - gmake ${BUILD_FLAGS} GIT=NO standalone-utils
  artifacts:
    expire_in: 30 mins
    name: "utils-${OSP}"
    paths:
      - "src/sbbs3/*.exe.release/*"
      - "src/sbbs3/*.obj.release*/*.o*"
  needs:
    - job: "ciolib-$[[ inputs.os ]]"
    - job: "encode-$[[ inputs.os ]]"
    - job: "gitinfo-$[[ inputs.os ]]"
    - job: "hash-$[[ inputs.os ]]"
    - job: "smblib-$[[ inputs.os ]]"
    - job: "uifc-$[[ inputs.os ]]"
    - job: "xpdev-$[[ inputs.os ]]"

"sbbs-$[[ inputs.os ]]":
  extends:
    - .$[[ inputs.os ]]-build
  script:
    - cd src/sbbs3
    - touch depend
    - touch xpdev
    - touch xpdev-mt
    - touch smblib
    - touch uifc
    - touch uifc-mt
    - touch ciolib-mt
    - touch encode
    - touch hash
    - touch smblib
    - touch sftp-mt
    - touch cl
    - gmake ${BUILD_FLAGS} GIT=NO all
  artifacts:
    name: "sbbs-${OSP}"
    paths:
      - "src/sbbs3/*.exe.release/*"
      - "src/sbbs3/*.lib.release/*"
      - "src/sbbs3/*/*.exe.release/*"
  needs:
    - job: "spidermonkey-$[[ inputs.os ]]"
    - job: "cryptlib-$[[ inputs.os ]]"
    - job: "xpdev-$[[ inputs.os ]]"
    - job: "encode-$[[ inputs.os ]]"
    - job: "hash-$[[ inputs.os ]]"
    - job: "sftp-$[[ inputs.os ]]"
    - job: "smblib-$[[ inputs.os ]]"
    - job: "ciolib-$[[ inputs.os ]]"
    - job: "uifc-$[[ inputs.os ]]"
    - job: "gitinfo-$[[ inputs.os ]]"
    - job: "scfg-$[[ inputs.os ]]"
    - job: "uedit-$[[ inputs.os ]]"
    - job: "umonitor-$[[ inputs.os ]]"
    - job: "utils-$[[ inputs.os ]]"
  rules:
    - if: $NO_JAVASCRIPT == "yes"
      when: never
    - if: $CROSS_PLATFORM == "yes"
      when: never
    - changes:
      - src/**/*
      - 3rdp/**/*
      - ctrl/text.dat
      - xtrn/**/{GNUm,M}akefile
      - xtrn/**/*.{c,h,cpp,hpp,mk}

"syncterm-$[[ inputs.os ]]":
  extends:
    - .$[[ inputs.os ]]-build
  script:
    - cd src/syncterm
    - touch depend
    - touch xpdev
    - touch xpdev-mt
    - touch encode
    - touch hash
    - touch ciolib-mt
    - touch uifc
    - touch uifc-mt
    - touch sftp-mt
    - touch cl
    - gmake ${BUILD_FLAGS}
  artifacts:
    name: "syncterm-${OSP}"
    paths:
      - "src/syncterm/*.exe.release/*"
  needs:
    - job: "ciolib-$[[ inputs.os ]]"
    - job: "cryptlib-$[[ inputs.os ]]"
    - job: "encode-$[[ inputs.os ]]"
    - job: "hash-$[[ inputs.os ]]"
    - job: "sftp-$[[ inputs.os ]]"
    - job: "uifc-$[[ inputs.os ]]"
    - job: "xpdev-$[[ inputs.os ]]"

"syncdraw-$[[ inputs.os ]]":
  extends:
    - .$[[ inputs.os ]]-build
  script:
    - cd src/syncdraw
    - touch depend
    - touch xpdev
    - touch xpdev-mt
    - touch ciolib-mt
    - gmake ${BUILD_FLAGS}
  artifacts:
    name: "syncdraw-${OSP}"
    paths:
      - "src/syncdraw/*.exe.release/*"
  needs:
    - job: "ciolib-$[[ inputs.os ]]"
    - job: "xpdev-$[[ inputs.os ]]"

"jsdoor-$[[ inputs.os ]]":
  extends:
    - .$[[ inputs.os ]]-build
  script:
    - cd src/sbbs3
    - touch depend
    - touch xpdev
    - touch xpdev-mt
    - touch encode
    - touch hash
    - touch smblib
    - touch ciolib-mt
    - touch uifc
    - touch uifc-mt
    - touch sftp-mt
    - touch cl
    - gmake ${BUILD_FLAGS} jsdoor
  artifacts:
    name: "jsdoor-${OSP}"
    paths:
      - "src/sbbs3/*.exe.release/*"
  needs:
    - job: "ciolib-$[[ inputs.os ]]"
    - job: "cryptlib-$[[ inputs.os ]]"
    - job: "encode-$[[ inputs.os ]]"
    - job: "hash-$[[ inputs.os ]]"
    - job: "sftp-$[[ inputs.os ]]"
    - job: "smblib-$[[ inputs.os ]]"
    - job: "spidermonkey-$[[ inputs.os ]]"
    - job: "uifc-$[[ inputs.os ]]"
    - job: "xpdev-$[[ inputs.os ]]"
  rules:
    - if: $NO_JAVASCRIPT == "yes"
      when: never
    - changes:
      - src/**/*
      - 3rdp/**/*
      - ctrl/text.dat
      - xtrn/**/{GNUm,M}akefile
      - xtrn/**/*.{c,h,cpp,hpp,mk}

"sexpots-$[[ inputs.os ]]":
  extends:
    - .$[[ inputs.os ]]-build
  script:
    - cd src/sexpots
    - touch depend
    - touch xpdev
    - touch xpdev-mt
    - gmake ${BUILD_FLAGS}
  artifacts:
    name: "sexpots-${OSP}"
    paths:
      - "src/sexpots/*.exe.release/*"
  needs:
    - job: "xpdev-$[[ inputs.os ]]"

"js-testsuite-$[[ inputs.os ]]":
  extends:
    - .$[[ inputs.os ]]-test
  script:
    - "src/sbbs3/*.exe.release/jsdoor exec/tests/test.js"
  dependencies:
    - "jsdoor-$[[ inputs.os ]]"
  rules:
    - if: $CROSS_PLATFORM == "yes"
      when: never
    - if: $NO_JAVASCRIPT == "yes"
      when: never
    - changes:
      - src/**/*
      - 3rdp/**/*
      - ctrl/text.dat
      - xtrn/**/{GNUm,M}akefile
      - xtrn/**/*.{c,h,cpp,hpp,mk}
